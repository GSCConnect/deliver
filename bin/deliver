#!/usr/bin/env bash

# If a specific part fails (I'm thinking mostly remote commands),
# I will fail the script explicitly, don't want it to just die
# set -e

BASE_PATH="$(dirname $0)/.."

# All functions starting with __ are private ones
# You can overwrite them, but ideally they should be left alone.
# Remember Demeter: http://ablogaboutcode.com/2012/02/27/understanding-the-law-of-demeter/

source "$BASE_PATH/libexec/output"
source "$BASE_PATH/libexec/states"
source "$BASE_PATH/libexec/defaults"
source "$BASE_PATH/libexec/core"
source "$BASE_PATH/libexec/common"

__complain_if_interrupted
__capture_runtime_configs
__find_all_strategies

source "$BASE_PATH/libexec/init"

__load_app_config
__default_app_config
__apply_runtime_configs
__load_strategy
__remote_hosts

__check_config

# Run the loaded strategy
# Can be overwritten by each strategy, e.g. custom output
# When testing, only output the commands which would be run
#
[ ! $MODE = "test" ] && begin
run
[ ! $MODE = "test" ] && finish

exit 0
